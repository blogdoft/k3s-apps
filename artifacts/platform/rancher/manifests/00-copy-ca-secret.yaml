---
# ServiceAccount for the CA copy job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ca-copier
  namespace: cattle-system
  annotations:
    argocd.argoproj.io/sync-wave: "-5"
---
# ClusterRole to read secrets from cert-manager namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ca-secret-reader
  annotations:
    argocd.argoproj.io/sync-wave: "-5"
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]
    resourceNames: ["home-arpa-ca"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "update", "patch"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ca-copier-binding
  annotations:
    argocd.argoproj.io/sync-wave: "-5"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ca-secret-reader
subjects:
  - kind: ServiceAccount
    name: ca-copier
    namespace: cattle-system
---
# Job to copy CA certificate from cert-manager to cattle-system
apiVersion: batch/v1
kind: Job
metadata:
  name: copy-ca-cert
  namespace: cattle-system
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      name: copy-ca-cert
    spec:
      serviceAccountName: ca-copier
      restartPolicy: OnFailure
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for home-arpa-ca secret to be available..."
              
              # Wait for the secret to exist (max 5 minutes)
              for i in $(seq 1 30); do
                if kubectl get secret home-arpa-ca -n cert-manager >/dev/null 2>&1; then
                  echo "Found home-arpa-ca secret"
                  break
                fi
                echo "Waiting for home-arpa-ca secret... ($i/30)"
                sleep 10
              done
              
              # Extract the CA certificate
              echo "Extracting CA certificate..."
              kubectl get secret home-arpa-ca -n cert-manager -o jsonpath='{.data.tls\.crt}' | base64 -d > /tmp/cacerts.pem
              
              # Check if the secret already exists
              if kubectl get secret tls-ca -n cattle-system >/dev/null 2>&1; then
                echo "Secret tls-ca already exists, updating..."
                kubectl create secret generic tls-ca \
                  --from-file=cacerts.pem=/tmp/cacerts.pem \
                  --dry-run=client -o yaml | \
                  kubectl apply -f -
              else
                echo "Creating secret tls-ca..."
                kubectl create secret generic tls-ca \
                  --from-file=cacerts.pem=/tmp/cacerts.pem \
                  -n cattle-system
              fi
              
              echo "CA certificate copied successfully!"
